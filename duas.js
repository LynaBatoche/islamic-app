// duas.js - Fixed version

// Duas Data Structure
globalThis.duasData = {
    morning: [
        {
            id: 'morning-1',
            title: 'Morning Remembrance',
            titleKey: 'duas.morningDua1',
            arabic: `أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ، رَبِّ أَسْأَلُكَ خَيْرَ مَا فِي هَذَا الْيَوْمِ وَخَيْرَ مَا بَعْدَهُ، وَأَعُوذُ بِكَ مِنْ شَرِّ مَا فِي هَذَا الْيَوْمِ وَشَرِّ مَا بَعْدَهُ، رَبِّ أَعُوذُ بِكَ مِنَ الْكَسَلِ وَسُوءِ الْكِبَرِ، رَبِّ أَعُوذُ بِكَ مِنْ عَذَابٍ فِي النَّارِ وَعَذَابٍ فِي الْقَبْرِ`,
            transliteration: '"Asbahna wa asbahal-mulku lillahi walhamdu lillahi, la ilaha illallahu wahdahu la sharika lahu, lahul-mulku wa lahul-hamdu wa huwa \'ala kulli shay\'in qadir. Rabbi as\'aluka khayra ma fi hadhal-yawmi wa khayra ma ba\'dahu, wa a\'udhu bika min sharri ma fi hadhal-yawmi wa sharri ma ba\'dahu. Rabbi a\'udhu bika minal-kasali wa su\'il-kibari. Rabbi a\'udhu bika min \'adhabin fin-nari wa \'adhabin fil-qabri."',
            translation: "We have reached the morning and at this very time all sovereignty belongs to Allah, and all praise is for Allah. None has the right to be worshiped except Allah, alone, without partner. To Him belongs all sovereignty and praise and He is over all things omnipotent. My Lord, I ask You for the good of this day and the good of what follows it and I take refuge in You from the evil of this day and the evil of what follows it. My Lord, I take refuge in You from laziness and senility. My Lord, I take refuge in You from the torment of Hell and the torment of the grave.",
            translationKey: 'duas.morningDua1Trans',
            reference: "Muslim 4/2088",
            referenceKey: 'duas.morningDua1Ref',
            category: 'protection',
            tags: ['protection', 'remembrance', 'morning']
        },
        {
            id: 'morning-2',
            title: 'Protection and Trust',
            titleKey: 'duas.morningDua2',
            arabic: `بِسْمِ اللَّهِ الَّذِي لَا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الْأَرْضِ وَلَا فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ`,
            transliteration: '"Bismillahi alladhi la yadurru ma\'as-mihi shay\'un fil-ardi wa la fis-sama\'i wa huwas-sami\'ul-\'alim"',
            translation: "In the name of Allah, with whose name nothing can cause harm in the earth nor in the heavens, and He is the All-Hearing, the All-Knowing.",
            translationKey: 'duas.morningDua2Trans',
            reference: "Abu Dawud 4/323",
            referenceKey: 'duas.morningDua2Ref',
            category: 'protection',
            tags: ['protection', 'trust', 'morning']
        },
        {
            id: 'morning-3',
            title: 'Seeking Forgiveness',
            titleKey: 'duas.morningDua3',
            arabic: `اللَّهُمَّ أَنْتَ رَبِّي لَا إِلَهَ إِلَّا أَنْتَ خَلَقْتَنِي وَأَنَا عَبْدُكَ وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ وَأَبُوءُ بِذَنْبِي فَاغْفِرْ لِي فَإِنَّهُ لَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ`,
            transliteration: '"Allahumma anta rabbi la ilaha illa anta khalaqtani wa ana \'abduka wa ana \'ala \'ahdika wa wa\'dika ma istata\'tu a\'udhu bika min sharri ma sana\'tu abu\'u laka bini\'matika \'alayya wa abu\'u bidhanbi faghfir li fa innahu la yaghfirudh-dhunuba illa anta"',
            translation: "O Allah, You are my Lord, none has the right to be worshiped except You, You created me and I am Your servant and I abide to Your covenant and promise as best I can, I take refuge in You from the evil of which I have committed. I acknowledge Your favor upon me and I acknowledge my sin, so forgive me, for verily none can forgive sin except You.",
            translationKey: 'duas.morningDua3Trans',
            reference: "Bukhari 8/150",
            referenceKey: 'duas.morningDua3Ref',
            category: 'forgiveness',
            tags: ['forgiveness', 'repentance', 'morning']
        },
        {
            id: 'morning-4',
            title: 'Blessing of the Day',
            titleKey: 'duas.morningDua4',
            arabic: `اللَّهُمَّ إِنِّي أَسْأَلُكَ عِلْمًا نَافِعًا وَرِزْقًا طَيِّبًا وَعَمَلًا مُتَقَبَّلًا`,
            transliteration: '"Allahumma inni as\'aluka \'ilman nafi\'an wa rizqan tayyiban wa \'amalan mutaqabbalan"',
            translation: "O Allah, I ask You for beneficial knowledge, good provision, and accepted deeds.",
            translationKey: 'duas.morningDua4Trans',
            reference: "Ibn Majah 1/925",
            referenceKey: 'duas.morningDua4Ref',
            category: 'blessings',
            tags: ['blessings', 'knowledge', 'provision', 'morning']
        }
    ],
    evening: [
        {
            id: 'evening-1',
            title: 'Evening Remembrance',
            titleKey: 'duas.eveningDua1',
            arabic: `أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ، رَبِّ أَسْأَلُكَ خَيْرَ مَا فِي هَذِهِ اللَّيْلَةِ وَخَيْرَ مَا بَعْدَهَا، وَأَعُوذُ بِكَ مِنْ شَرِّ مَا فِي هَذِهِ اللَّيْلَةِ وَشَرِّ مَا بَعْدَهَا، رَبِّ أَعُوذُ بِكَ مِنَ الْكَسَلِ وَسُوءِ الْكِبَرِ، رَبِّ أَعُوذُ بِكَ مِنْ عَذَابٍ فِي النَّارِ وَعَذَابٍ فِي الْقَبْرِ`,
            transliteration: '"Amsayna wa amsal-mulku lillahi walhamdu lillahi, la ilaha illallahu wahdahu la sharika lahu, lahul-mulku wa lahul-hamdu wa huwa \'ala kulli shay\'in qadir. Rabbi as\'aluka khayra ma fi hadhihil-laylati wa khayra ma ba\'daha, wa a\'udhu bika min sharri ma fi hadhihil-laylati wa sharri ma ba\'daha. Rabbi a\'udhu bika minal-kasali wa su\'il-kibari. Rabbi a\'udhu bika min \'adhabin fin-nari wa \'adhabin fil-qabri."',
            translation: "We have reached the evening and at this very time all sovereignty belongs to Allah, and all praise is for Allah. None has the right to be worshiped except Allah, alone, without partner. To Him belongs all sovereignty and praise and He is over all things omnipotent. My Lord, I ask You for the good of this night and the good of what follows it and I take refuge in You from the evil of this night and the evil of what follows it. My Lord, I take refuge in You from laziness and senility. My Lord, I take refuge in You from the torment of Hell and the torment of the grave.",
            translationKey: 'duas.eveningDua1Trans',
            reference: "Muslim 4/2088",
            referenceKey: 'duas.eveningDua1Ref',
            category: 'protection',
            tags: ['protection', 'remembrance', 'evening']
        },
        {
            id: 'evening-2',
            title: 'Evening Protection',
            titleKey: 'duas.eveningDua2',
            arabic: `بِسْمِ اللَّهِ الَّذِي لَا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الْأَرْضِ وَلَا فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ`,
            transliteration: '"Bismillahi alladhi la yadurru ma\'as-mihi shay\'un fil-ardi wa la fis-sama\'i wa huwas-sami\'ul-\'alim"',
            translation: "In the name of Allah, with whose name nothing can cause harm in the earth nor in the heavens, and He is the All-Hearing, the All-Knowing.",
            translationKey: 'duas.eveningDua2Trans',
            reference: "Abu Dawud 4/323",
            referenceKey: 'duas.eveningDua2Ref',
            category: 'protection',
            tags: ['protection', 'trust', 'evening']
        },
        {
            id: 'evening-3',
            title: 'Evening Tasbih',
            titleKey: 'duas.eveningDua3',
            arabic: `سُبْحَانَ اللَّهِ وَبِحَمْدِهِ عَدَدَ خَلْقِهِ وَرِضَا نَفْسِهِ وَزِنَةَ عَرْشِهِ وَمِدَادَ كَلِمَاتِهِ`,
            transliteration: '"Subhanallahi wa bihamdihi \'adada khalqihi wa rida nafsihi wa zinata \'arshihi wa midada kalimatihi"',
            translation: "How perfect Allah is and I praise Him by the number of His creation and His pleasure, and by the weight of His throne, and the ink of His words.",
            translationKey: 'duas.eveningDua3Trans',
            reference: "Muslim 4/2090",
            referenceKey: 'duas.eveningDua3Ref',
            category: 'remembrance',
            tags: ['remembrance', 'tasbih', 'evening']
        }
    ],
    night: [
        {
            id: 'night-1',
            title: 'Before Sleeping',
            titleKey: 'duas.nightDua1',
            arabic: `بِاسْمِكَ اللَّهُمَّ أَمُوتُ وَأَحْيَا`,
            transliteration: '"Bismika allahumma amutu wa ahya"',
            translation: "In Your name O Allah, I die and I live.",
            translationKey: 'duas.nightDua1Trans',
            reference: "Bukhari 11/113",
            referenceKey: 'duas.nightDua1Ref',
            category: 'protection',
            tags: ['protection', 'sleep', 'night']
        },
        {
            id: 'night-2',
            title: 'Sleeping Dua',
            titleKey: 'duas.nightDua2',
            arabic: `اللَّهُمَّ قِنِي عَذَابَكَ يَوْمَ تَبْعَثُ عِبَادَكَ`,
            transliteration: '"Allahumma qini \'adhabaka yawma tab\'athu \'ibadak"',
            translation: "O Allah, protect me from Your punishment on the Day You resurrect Your servants.",
            translationKey: 'duas.nightDua2Trans',
            reference: "Tirmidhi 5/534",
            referenceKey: 'duas.nightDua2Ref',
            category: 'protection',
            tags: ['protection', 'sleep', 'night']
        },
        {
            id: 'night-3',
            title: 'Ayat al-Kursi Before Sleep',
            titleKey: 'duas.nightDua3',
            arabic: `اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ ۚ لَا تَأْخُذُهُ سِنَةٌ وَلَا نَوْمٌ ۚ لَهُ مَا فِي السَّمَاوَاتِ وَمَا فِي الْأَرْضِ ۗ مَنْ ذَا الَّذِي يَشْفَعُ عِنْدَهُ إِلَّا بِإِذْنِهِ ۚ يَعْلَمُ مَا بَيْنَ أَيْدِيهِمْ وَمَا خَلْفَهُمْ ۖ وَلَا يُحِيطُونَ بِشَيْءٍ مِنْ عِلْمِهِ إِلَّا بِمَا شَاءَ ۚ وَسِعَ كُرْسِيُّهُ السَّمَاوَاتِ وَالْأَرْضَ ۖ وَلَا يَئُودُهُ حِفْظُهُمَا ۚ وَهُوَ الْعَلِيُّ الْعَظِيمُ`,
            transliteration: '"Allahu la ilaha illa huwa al-hayy al-qayyum, la ta\'khuthuhu sinatun wala nawm, lahu ma fis-samawati wa ma fil-ard, man dhal-ladhi yashfa\'u \'indahu illa bi-idhnihi, ya\'lamu ma bayna aydayhim wa ma khalfahum, wa la yuhituna bishay\'im min \'ilmihi illa bima sha\'a, wasi\'a kursiyyuhus-samawati wal-arda, wa la ya\'uduhu hifdhuhuma, wa huwal-\'aliyyul-\'azim."',
            translation: "Allah! There is no deity except Him, the Ever-Living, the Sustainer of existence. Neither drowsiness overtakes Him nor sleep. To Him belongs whatever is in the heavens and whatever is on the earth. Who is it that can intercede with Him except by His permission? He knows what is before them and what will be after them, and they encompass not a thing of His knowledge except for what He wills. His Kursi extends over the heavens and the earth, and their preservation tires Him not. And He is the Most High, the Most Great.",
            translationKey: 'duas.nightDua3Trans',
            reference: "Quran 2:255",
            referenceKey: 'duas.nightDua3Ref',
            category: 'protection',
            tags: ['protection', 'quran', 'ayat-al-kursi', 'night']
        }
    ],
    special: [
        {
            id: 'special-1',
            title: 'Travel Dua',
            titleKey: 'duas.travelDua',
            arabic: 'سُبْحَانَ الَّذِي سَخَّرَ لَنَا هَذَا وَمَا كُنَّا لَهُ مُقْرِنِينَ وَإِنَّا إِلَى رَبِّنَا لَمُنْقَلِبُونَ',
            transliteration: '"Subhana alladhi sakhkhara lana hadha wa ma kunna lahu muqrinin wa inna ila rabbina lamunqalibun"',
            translation: "Glory is to Him Who has provided this for us though we could never have had it by our efforts. Verily, to Our Lord we are returning.",
            translationKey: 'duas.travelDuaTrans',
            reference: "Quran 43:13",
            referenceKey: 'duas.travelDuaRef',
            category: 'travel',
            tags: ['travel', 'journey', 'protection']
        },
        {
            id: 'special-2',
            title: 'Dua for the Sick',
            titleKey: 'duas.sicknessDua',
            arabic: 'اللَّهُمَّ رَبَّ النَّاسِ أَذْهِبِ الْبَأْسَ وَاشْفِ أَنْتَ الشَّافِي لَا شِفَاءَ إِلَّا شِفَاؤُكَ شِفَاءً لَا يُغَادِرُ سَقَمًا',
            transliteration: '"Allahumma rabban-nasi adhhibil ba\'sa washfi antash-shafi la shifa\'a illa shifa\'uka shifa\'an la yughadiru saqaman"',
            translation: "O Allah, Lord of mankind, remove the hardship and grant healing as You are the Healer. There is no healing except Your healing, a healing that leaves no illness behind.",
            translationKey: 'duas.sicknessDuaTrans',
            reference: "Bukhari 7/580",
            referenceKey: 'duas.sicknessDuaRef',
            category: 'health',
            tags: ['health', 'healing', 'sickness']
        },
        {
            id: 'special-3',
            title: 'Dua for Parents',
            titleKey: 'duas.parentsDua',
            arabic: 'رَبِّ ارْحَمْهُمَا كَمَا رَبَّيَانِي صَغِيرًا',
            transliteration: '"Rabbi irhamhuma kama rabbayani saghira"',
            translation: "My Lord, have mercy upon them as they brought me up when I was small.",
            translationKey: 'duas.parentsDuaTrans',
            reference: "Quran 17:24",
            referenceKey: 'duas.parentsDuaRef',
            category: 'family',
            tags: ['parents', 'mercy', 'family']
        }
    ]
};

// Favorites Manager
class FavoritesManager {
    key = 'hidaya_favorites';
    
    constructor() {
        this.favorites = this.loadFavorites();
    }

    loadFavorites() {
        const saved = localStorage.getItem(this.key);
        return saved ? JSON.parse(saved) : [];
    }

    saveFavorites() {
        localStorage.setItem(this.key, JSON.stringify(this.favorites));
    }

    addFavorite(duaId) {
        if (!this.isFavorite(duaId)) {
            this.favorites.push(duaId);
            this.saveFavorites();
            this.showNotification('Dua added to favorites');
            return true;
        }
        return false;
    }

    removeFavorite(duaId) {
        const index = this.favorites.indexOf(duaId);
        if (index > -1) {
            this.favorites.splice(index, 1);
            this.saveFavorites();
            this.showNotification('Dua removed from favorites');
            return true;
        }
        return false;
    }

    isFavorite(duaId) {
        return this.favorites.includes(duaId);
    }

    toggleFavorite(duaId) {
        if (this.isFavorite(duaId)) {
            this.removeFavorite(duaId);
            return false;
        } else {
            this.addFavorite(duaId);
            return true;
        }
    }

    getFavorites() {
        return this.favorites;
    }

    showNotification(message) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        
        if (toast && toastMessage) {
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    }
}

// Dua Manager Class
class DuaManager {
    constructor() {
        this.favoritesManager = new FavoritesManager();
        this.currentCategory = 'morning';
        this.init();
    }

    init() {
        this.bindEvents();
        this.renderDuas();
        this.renderFavorites();
    }

    bindEvents() {
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const category = e.target.dataset.category;
                this.switchCategory(category);
            });
        });

        // Copy to clipboard functionality (delegated)
        document.addEventListener('click', (e) => {
            if (e.target.closest('.copy-btn')) {
                const duaCard = e.target.closest('.dua-card');
                if (duaCard) {
                    this.copyDuaToClipboard(duaCard);
                }
            }

            if (e.target.closest('.favorite-btn')) {
                const duaCard = e.target.closest('.dua-card');
                if (duaCard) {
                    const duaId = duaCard.dataset.duaId;
                    this.toggleFavorite(duaId, duaCard);
                }
            }
        });
    }

    switchCategory(category) {
        // Update active tab
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.category === category);
        });

        // Update active category content
        document.querySelectorAll('.duas-category').forEach(cat => {
            cat.classList.toggle('active', cat.id === `${category}-duas`);
        });

        this.currentCategory = category;
        this.renderDuas();
    }

    createDuaCard(dua) {
        const isFavorite = this.favoritesManager.isFavorite(dua.id);
        const favoriteIcon = isFavorite ? 'fas fa-heart' : 'far fa-heart';
        const favoriteTitle = isFavorite ? 'Remove from favorites' : 'Add to favorites';

        return `
            <div class="dua-card" data-dua-id="${dua.id}" data-category="${dua.category}">
                <div class="dua-header">
                    <div class="dua-title">
                        <h3>${dua.title}</h3>
                        <span class="dua-category-tag">${dua.category}</span>
                    </div>
                    <div class="dua-actions">
                        <button class="copy-btn" title="Copy dua">
                            <i class="far fa-copy"></i>
                        </button>
                        <button class="favorite-btn" title="${favoriteTitle}">
                            <i class="${favoriteIcon}"></i>
                        </button>
                    </div>
                </div>
                <div class="dua-arabic" dir="rtl" lang="ar">
                    ${dua.arabic}
                </div>
                <div class="dua-transliteration">
                    ${dua.transliteration}
                </div>
                <div class="dua-translation">
                    ${dua.translation}
                </div>
                <div class="dua-reference">
                    <span class="reference-label">Reference:</span>
                    <span class="reference-text">${dua.reference}</span>
                </div>
            </div>
        `;
    }

    renderDuas() {
        const categoryContainer = document.getElementById(`${this.currentCategory}-duas`);
        if (!categoryContainer) return;

        let duas = globalThis.duasData[this.currentCategory] || [];

        // Clear existing content except the category info
        const existingCards = categoryContainer.querySelectorAll('.dua-card');
        existingCards.forEach(card => card.remove());

        // Create container if it doesn't exist
        if (!categoryContainer.querySelector('.duas-cards')) {
            const container = document.createElement('div');
            container.className = 'duas-cards';
            categoryContainer.appendChild(container);
        }

        const cardsContainer = categoryContainer.querySelector('.duas-cards');
        
        if (duas.length === 0) {
            cardsContainer.innerHTML = `
                <div class="no-duas-found">
                    <i class="fas fa-search"></i>
                    <p>No duas found in this category.</p>
                </div>
            `;
        } else {
            cardsContainer.innerHTML = duas.map(dua => this.createDuaCard(dua)).join('');
        }
    }

    renderFavorites() {
        const favoritesContainer = document.getElementById('favoritesContainer');
        if (!favoritesContainer) return;

        const favoriteIds = this.favoritesManager.getFavorites();
        
        if (favoriteIds.length === 0) {
            favoritesContainer.innerHTML = `
                <p class="empty-favorites">No favorite duas yet. Click the heart icon to add some.</p>
            `;
            return;
        }

        // Get all duas that are favorites
        let favoriteDuas = [];
        Object.keys(globalThis.duasData).forEach(category => {
            globalThis.duasData[category].forEach(dua => {
                if (favoriteIds.includes(dua.id)) {
                    favoriteDuas.push(dua);
                }
            });
        });

        if (favoriteDuas.length === 0) {
            favoritesContainer.innerHTML = `
                <p class="empty-favorites">No favorite duas yet. Click the heart icon to add some.</p>
            `;
            return;
        }

        favoritesContainer.innerHTML = favoriteDuas.map(dua => this.createDuaCard(dua)).join('');
    }

    copyDuaToClipboard(duaCard) {
        const arabicText = duaCard.querySelector('.dua-arabic').textContent;
        const transliteration = duaCard.querySelector('.dua-transliteration').textContent;
        const translation = duaCard.querySelector('.dua-translation').textContent;
        
        const textToCopy = `${arabicText}\n\n${transliteration}\n\n${translation}`;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            this.favoritesManager.showNotification('Dua copied to clipboard');
        }).catch(err => {
            console.error('Failed to copy dua: ', err);
            this.favoritesManager.showNotification('Failed to copy dua');
        });
    }

    toggleFavorite(duaId, duaCard) {
        const isNowFavorite = this.favoritesManager.toggleFavorite(duaId);
        
        // Update heart icon
        const heartIcon = duaCard.querySelector('.favorite-btn i');
        if (heartIcon) {
            heartIcon.className = isNowFavorite ? 'fas fa-heart' : 'far fa-heart';
            heartIcon.closest('.favorite-btn').title = isNowFavorite ? 
                'Remove from favorites' : 
                'Add to favorites';
        }
        
        // Update favorites section
        this.renderFavorites();
    }

    reloadDuas() {
        this.renderDuas();
        this.renderFavorites();
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    // Make sure the elements exist
    const tabsExist = document.querySelector('.duas-tabs');
    if (tabsExist) {
        globalThis.duaManager = new DuaManager();
        globalThis.reloadDuas = () => globalThis.duaManager?.reloadDuas();
    }
});